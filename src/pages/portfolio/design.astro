---
// Fetch and prepare all data as before
import { Image } from "astro:assets";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import type { ImageMetadata } from "astro";

const titleShort = "design";
const titleFull = "design";

// import collection and sort by date
const design = await getCollection("design");
const designItems = design.map((item) => item.data);
// Sort newest relevant_date
designItems.sort((a, b) =>
  new Date(b.created) > new Date(a.created) ? 1 : -1,
);

const imageImports = import.meta.glob<{ default: ImageMetadata }>(
  "../../content/300-collections/portfolio/images/*",
);

const designItemsWithImports = await Promise.all(
  designItems.map(async (item) => {
    // Resolve images and filter out any that weren't found (nulls)
    const imgDataArr = (
      await Promise.all(
        (item.images || []).map(async (imagePath) => {
          const imageFileName = imagePath.replace(/^.*images\//, "");
          const globKey = `../../content/300-collections/portfolio/images/${imageFileName}`;
          if (imageImports[globKey]) {
            return (await imageImports[globKey]()).default;
          } else {
            console.warn(
              "Image not found via import.meta.glob mapping:",
              globKey,
            );
            return null;
          }
        }),
      )
    ).filter(Boolean); // <-- filters out nulls and undefined

    return { ...item, imgDataArr }; // Array of ImageMetadata only
  }),
);

const narrowItems = designItemsWithImports.filter(
  (item) => item.image_size === "narrow",
);
const wideItems = designItemsWithImports.filter(
  (item) => item.image_size === "wide",
);
---

<BaseLayout titleShort={titleShort} titleFull={titleFull}>
  <p class="text-content-1 pb-6 text-center">
    (assorted graphic design + branding projects, completed for fun / friends /
    work)
  </p>

  <div class="container mx-auto w-full px-4 pb-6 md:max-w-3/4 lg:max-w-2/3">
    {/* wide items */}
    <div class="mx-auto mb-6 flex flex-col items-center gap-6">
      {
        wideItems.map((item) => (
          <div class="bg-surface-1 flex flex-col items-center rounded-xl p-4 text-center md:max-w-3/4 md:p-6 lg:max-w-2/3">
            <span class="font-header text-content-1 text-center text-xl font-semibold tracking-wide lowercase">
              {item.title} ({item.created.getFullYear()})
            </span>
            <p class="text-content-2 mt-2 leading-tight lowercase">
              {item.description}
            </p>
            {item.link_to_more && (
              <a
                class="font-base text-content-3 hover:text-content-4 soft-transition focus-outline-rounded mt-2 text-base font-semibold"
                href={item.link_to_more}
                target="_blank"
              >
                see more
              </a>
            )}

            <div class="bg-surface-3 mt-4 flex max-h-[16rem] max-w-full flex-col gap-4 overflow-y-auto rounded-xl p-2 md:max-w-3/4 md:p-4">
              {item.imgDataArr.map(
                (imgData, idx) =>
                  imgData && (
                    <Image
                      src={imgData}
                      alt={item.description ?? item.title ?? "design"}
                      loading="eager"
                      width={1200}
                      height={800}
                      sizes="(max-width: 800px) 100vw, (max-width: 1200px) 33vw, 25vw"
                      class="h-auto w-full"
                    />
                  ),
              )}
            </div>
          </div>
        ))
      }
    </div>

    {/* narrow items */}
    <div
      class="mx-auto mb-6 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"
    >
      {
        narrowItems.map((item) => (
          <div class="bg-surface-1 flex w-full flex-col items-center rounded-xl p-4 text-center md:p-6">
            <span class="font-header text-content-1 text-center text-xl font-semibold tracking-wide lowercase">
              {item.title} ({item.created.getFullYear()})
            </span>
            <p class="text-content-2 mt-2 leading-tight lowercase">
              {item.description}
            </p>
            {item.link_to_more && (
              <a
                class="font-base text-content-3 hover:text-content-4 soft-transition focus-outline-rounded mt-2 text-base font-semibold"
                href={item.link_to_more}
                target="_blank"
              >
                see more
              </a>
            )}

            <div class="bg-surface-3 mt-4 flex max-h-[16rem] max-w-2/5 flex-col gap-4 overflow-y-auto rounded-xl p-2 md:max-w-3/4 md:p-4">
              {item.imgDataArr.map(
                (imgData, idx) =>
                  imgData && (
                    <Image
                      src={imgData}
                      alt={item.description ?? item.title ?? "design"}
                      loading="eager"
                      width={600}
                      height={400}
                      sizes="(max-width: 800px) 100vw, (max-width: 1200px) 33vw, 25vw"
                      class="h-auto w-full"
                    />
                  ),
              )}
            </div>
          </div>
        ))
      }
    </div>
  </div>
</BaseLayout>
