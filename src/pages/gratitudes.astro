---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import MasonryGrid from "@/components/ui/MasonryGrid.astro";
import { getCollection } from "astro:content";

const titleShort = ":)";
const titleFull = "thank you, world";

const gratitudes = await getCollection("gratitudes");

// Sort newest relevant_date
gratitudes.sort((a, b) =>
  new Date(b.data.relevant_date) > new Date(a.data.relevant_date) ? 1 : -1,
);

function formatDate(date: Date): string {
  const newDate = new Date(date);
  const year = newDate.getFullYear();
  const month = String(newDate.getMonth() + 1).padStart(2, "0");
  const day = String(newDate.getDate()).padStart(2, "0");
  return `${year}/${month}/${day}`;
}

// Import images if present using Astro V4 dynamic asset import
const imageImports = import.meta.glob<{ default: ImageMetadata }>(
  "../content/300-collections/gratitudes/images/*",
);

const itemsWithImageImports = await Promise.all(
  gratitudes.map(async (item) => {
    let imgSrc = null;
    if (item.data.image) {
      // item.image: '../images/filename.png'
      // Remove '../images/' prefix â€“ get IMAGE FILENAME
      const imageFileName = item.data.image.replace(/^\.\.\/images\//, "");
      // Build the glob key: it must match exactly as the key in imageImports
      const globKey = `../content/300-collections/gratitudes/images/${imageFileName}`;
      if (imageImports[globKey]) {
        imgSrc = (await imageImports[globKey]()).default;
      } else {
        console.warn("Image not found via import.meta.glob mapping:", globKey);
      }
    }
    return { ...item, imgSrc };
  }),
);
---

<BaseLayout titleShort={titleShort} titleFull={titleFull}>
  <p class="text-content-1 pb-6 text-center">
    (smile-inducing, gratitude-provoking, and otherwise noteworthy moments)
  </p>

  <MasonryGrid colsLg={4} class="mx-auto max-w-3/4">
    {
      itemsWithImageImports.map((item, index) => (
        <masonry-item
          id={item.id}
          data-pagefind-body
          data-pagefind-title="${item.data.redacted_content}"
          data-pagefind-url="/gratitudes#${item.slug}"
          class={`overflow-hidden rounded-xl ${
            item.imgSrc
              ? "h-auto w-full"
              : "bg-surface-2 hover:bg-surface-3 soft-transition flex flex-col justify-between"
          }`}
        >
          {item.imgSrc ? (
            <div class="group relative h-full">
              <Image
                src={item.imgSrc}
                alt={item.data.redacted_content}
                loading={index < 20 ? "eager" : "lazy"}
                class="h-full w-full object-cover"
              />
              <div class="bg-content-0 soft-transition absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-80">
                <p class="text-content-4 soft-transition p-4 text-center text-base font-semibold text-ellipsis lowercase opacity-0 group-hover:opacity-100">
                  {item.data.redacted_content}
                </p>
              </div>
              <p class="text-content-1 absolute right-2 bottom-2 px-2 py-1 font-mono text-base font-semibold">
                {formatDate(item.data.relevant_date)}
              </p>
            </div>
          ) : (
            <>
              <div class="flex flex-grow items-center justify-center p-4">
                <p class="text-content-2 group-hover:text-content-0 soft-transition text-center text-base font-light text-ellipsis lowercase">
                  {item.data.redacted_content}
                </p>
              </div>
              <p class="text-content-3 px-2 py-2 text-right font-mono text-base font-semibold">
                {formatDate(item.data.relevant_date)}
              </p>
            </>
          )}
        </masonry-item>
      ))
    }
  </MasonryGrid>
</BaseLayout>
